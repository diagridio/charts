name: Create new release

concurrency: "new-release"

on:
  workflow_dispatch:
    inputs:
      patch_catalyst_chart:
        description: "Patch an existing release for the Catalyst chart e.g. 0.3.0 -> 0.3.1"
        type: boolean
        default: false
      base_release_version:
        description: "Base release version to increment from. If omitted, the latest release will be used. e.g. 0.3.0"
        type: string
        required: false
      images_tag:
        description: "Diagrid container images tag to use for the release."
        type: string
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for git tag checking

    - name: Get next release version
      env:
        PATCH_CATALYST_CHART: ${{ inputs.patch_catalyst_chart }}
        BASE_RELEASE_VERSION: ${{ inputs.base_release_version }}
      run: |
        chmod +x .github/scripts/get-next-release-version.sh
        ./.github/scripts/get-next-release-version.sh

    # will create a new release branch. CI won't trigger on this branch because it was created by an workflow.
    - name: Create release branch
      run: |
        git config --global user.email "bot@diagrid.io"
        git config --global user.name "Diagrid Bot"
        git checkout -b ${{ env.RELEASE_BRANCH }} || git checkout ${{ env.RELEASE_BRANCH }}
        git push origin ${{ env.RELEASE_BRANCH }} || echo "Branch already up to date"

    - name: Update tags
      run: |
        make update-catalyst-tags IMAGES_TAG=${{ inputs.images_tag }}
    
    - name: Update chart version
      run: |
        make update-catalyst-chart-version VERSION=${{ env.VERSION }}

    - name: Create Pull Request to branch ${{ env.RELEASE_BRANCH }}
      id: cpr
      uses: peter-evans/create-pull-request@v7
      with:
        commit-message: "Prepare new release ${{ inputs.release_version }}, update tags to ${{ inputs.images_tag }}"
        title: "[Auto] Prepare new release ${{ inputs.release_version }}, update tags to ${{ inputs.images_tag }}"
        body: "Prepare new release ${{ inputs.release_version }}, update tags to ${{ inputs.images_tag }} ðŸŽ¬"
        base: ${{ env.RELEASE_BRANCH }}
        branch: prepate-release-${{ inputs.release_version }}
        delete-branch: true
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: automerge
