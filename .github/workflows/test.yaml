name: Test Helm Charts

on:
  pull_request:
    paths:
      - 'charts/**'
      - '.github/workflows/test.yaml'
      - 'tests/**'
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  helm-unittest:
    name: Helm Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add Helm Repositories
        run: |
          helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
          helm repo update

      - name: Build Helm Dependencies
        run: |
          cd charts/catalyst
          helm dependency build

      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git

      - name: Run unit tests
        run: |
          make update-catalyst-tags IMAGES_TAG=0.0.0
          cd charts/catalyst
          helm unittest --color .

  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add Helm Repositories
        run: |
          helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
          helm repo update

      - name: Build Helm Dependencies
        run: |
          cd charts/catalyst
          helm dependency build

      - name: Lint chart
        run: |
          make update-catalyst-tags IMAGES_TAG=0.0.0
          cd charts/catalyst
          helm lint . --set join_token="test-token"

  helm-template:
    name: Helm Template Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        scenario:
          - name: "default"
            args: "--set join_token=test"
          - name: "global-registry"
            args: "--set join_token=test --set global.image.registry=my-registry.io"
          - name: "consolidated"
            args: "--set join_token=test --set global.consolidated_image.enabled=true"
          - name: "consolidated-with-registry"
            args: "--set join_token=test --set global.consolidated_image.enabled=true --set global.image.registry=my-registry.io"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add Helm Repositories
        run: |
          helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
          helm repo update

      - name: Build Helm Dependencies
        run: |
          cd charts/catalyst
          helm dependency build

      - name: Template chart - ${{ matrix.scenario.name }}
        run: |
          make update-catalyst-tags IMAGES_TAG=0.0.0
          cd charts/catalyst
          helm template catalyst . ${{ matrix.scenario.args }} > /dev/null
          echo "âœ“ Template rendering successful for ${{ matrix.scenario.name }}"

  integration-tests:
    name: Helm Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: tests/integration/go.sum

      - name: Run integration tests
        timeout-minutes: 15
        run: |
          make update-catalyst-tags IMAGES_TAG=0.0.0
          make helm-test-integration
