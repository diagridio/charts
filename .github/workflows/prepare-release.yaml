name: Prepare new release

concurrency: "new-release"

on:
  workflow_dispatch:
    inputs:
      images_tag:
        description: "Diagrid container images tag to use for the release."
        type: string
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Update tags
      run: |
        make update-catalyst-tags IMAGES_TAG=${{ inputs.images_tag }}

    - name: Increment chart minor version
      run: |
        chmod +x .github/scripts/increment-chart-minor.sh
        ./.github/scripts/increment-chart-minor.sh

    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v7
      with:
        commit-message: "Prepare new release, update tags to ${{ inputs.images_tag }}"
        title: "[Auto] Prepare new release, update tags to ${{ inputs.images_tag }}"
        body: "Prepare new release, update tags to ${{ inputs.images_tag }} ðŸŽ¬"
        base: main
        branch: auto-prepare-release
        delete-branch: true
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: automerge
