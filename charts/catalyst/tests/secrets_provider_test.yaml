suite: Test Global Secrets Provider Configuration
templates:
  - agent/deployment.yaml
  - agent/configmap.yaml
  - management/deployment.yaml
  - management/configmap.yaml
  - gateway/gateway-controlplane-configmap.yaml
tests:
  # Test default Kubernetes provider
  - it: should use kubernetes secrets provider by default
    set:
      join_token: "test-token"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=kubernetes"
        template: agent/deployment.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: kubernetes"
        template: agent/configmap.yaml

  - it: should use kubernetes secrets provider in management by default
    set:
      join_token: "test-token"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=kubernetes"
        template: management/deployment.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: kubernetes"
        template: management/configmap.yaml

  # Test AWS Secrets Manager provider
  - it: should configure AWS secrets provider in agent
    set:
      join_token: "test-token"
      global.secrets.provider: "aws"
      global.secrets.aws.region: "us-east-1"
      global.secrets.aws.access_key: "AKIAIOSFODNN7EXAMPLE"
      global.secrets.aws.secret_access_key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=aws.secretmanager"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_aws_secretmanager.region=us-east-1"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_aws_secretmanager.access_key=AKIAIOSFODNN7EXAMPLE"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_aws_secretmanager.secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
        template: agent/deployment.yaml

  - it: should propagate AWS secrets to agent configmap
    set:
      join_token: "test-token"
      global.secrets.provider: "aws"
      global.secrets.aws.region: "us-west-2"
      global.secrets.aws.access_key: "AKIAIOSFODNN7EXAMPLE"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: aws"
        template: agent/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "region: us-west-2"
        template: agent/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "access_key: AKIAIOSFODNN7EXAMPLE"
        template: agent/configmap.yaml

  - it: should configure AWS secrets provider in management
    set:
      join_token: "test-token"
      global.secrets.provider: "aws"
      global.secrets.aws.region: "eu-west-1"
      global.secrets.aws.access_key: "AKIAIOSFODNN7EXAMPLE"
      global.secrets.aws.secret_access_key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=aws.secretmanager"
        template: management/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_aws_secretmanager.region=eu-west-1"
        template: management/deployment.yaml

  - it: should propagate AWS secrets to management configmap
    set:
      join_token: "test-token"
      global.secrets.provider: "aws"
      global.secrets.aws.region: "ap-southeast-1"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: aws"
        template: management/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "region: ap-southeast-1"
        template: management/configmap.yaml

  - it: should propagate AWS secrets to gateway configmap
    set:
      join_token: "test-token"
      global.secrets.provider: "aws"
      global.secrets.aws.region: "ca-central-1"
      global.secrets.aws.access_key: "AKIAIOSFODNN7EXAMPLE"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: aws"
        template: gateway/gateway-controlplane-configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "region: ca-central-1"
        template: gateway/gateway-controlplane-configmap.yaml

  # Test Redis provider
  - it: should configure Redis secrets provider in agent
    set:
      join_token: "test-token"
      global.secrets.provider: "redis"
      global.secrets.redis.host: "redis.example.com:6379"
      global.secrets.redis.password: "redis-password"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=redis"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.host=redis.example.com:6379"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.password=redis-password"
        template: agent/deployment.yaml

  - it: should propagate Redis secrets to agent configmap
    set:
      join_token: "test-token"
      global.secrets.provider: "redis"
      global.secrets.redis.host: "redis-cluster.svc.cluster.local:6379"
      global.secrets.redis.username: "admin"
      global.secrets.redis.password: "secure-password"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: redis"
        template: agent/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "host: redis-cluster.svc.cluster.local:6379"
        template: agent/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "username: admin"
        template: agent/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "password: secure-password"
        template: agent/configmap.yaml

  - it: should configure Redis secrets provider in management
    set:
      join_token: "test-token"
      global.secrets.provider: "redis"
      global.secrets.redis.host: "redis.internal:6379"
      global.secrets.redis.username: "mgmt-user"
      global.secrets.redis.password: "mgmt-pass"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=redis"
        template: management/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.host=redis.internal:6379"
        template: management/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.username=mgmt-user"
        template: management/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.password=mgmt-pass"
        template: management/deployment.yaml

  - it: should propagate Redis secrets to management configmap
    set:
      join_token: "test-token"
      global.secrets.provider: "redis"
      global.secrets.redis.host: "redis-sentinel:26379"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: redis"
        template: management/configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "host: redis-sentinel:26379"
        template: management/configmap.yaml

  - it: should propagate Redis secrets to gateway configmap
    set:
      join_token: "test-token"
      global.secrets.provider: "redis"
      global.secrets.redis.host: "redis-gateway:6379"
      global.secrets.redis.password: "gateway-redis-pass"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "provider: redis"
        template: gateway/gateway-controlplane-configmap.yaml
      - matchRegex:
          path: data["config.yaml"]
          pattern: "host: redis-gateway:6379"
        template: gateway/gateway-controlplane-configmap.yaml

  # Test that secrets object is present in all configmaps
  - it: should include secrets object in agent configmap with kubernetes provider
    set:
      join_token: "test-token"
      global.secrets.provider: "kubernetes"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "secrets:"
        template: agent/configmap.yaml

  - it: should include secrets object in management configmap with kubernetes provider
    set:
      join_token: "test-token"
      global.secrets.provider: "kubernetes"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "secrets:"
        template: management/configmap.yaml

  - it: should include secrets object in gateway configmap with kubernetes provider
    set:
      join_token: "test-token"
      global.secrets.provider: "kubernetes"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "secrets:"
        template: gateway/gateway-controlplane-configmap.yaml

  # Test edge cases
  - it: should handle empty AWS credentials gracefully
    set:
      join_token: "test-token"
      global.secrets.provider: "aws"
      global.secrets.aws.region: "us-east-1"
      global.secrets.aws.access_key: ""
      global.secrets.aws.secret_access_key: ""
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secretsprovider=aws.secretmanager"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_aws_secretmanager.region=us-east-1"
        template: agent/deployment.yaml
      # Empty credentials should still be passed as empty strings
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_aws_secretmanager.access_key="
        template: agent/deployment.yaml

  - it: should handle Redis without username
    set:
      join_token: "test-token"
      global.secrets.provider: "redis"
      global.secrets.redis.host: "redis:6379"
      global.secrets.redis.password: "only-password"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.host=redis:6379"
        template: agent/deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--secrets_redis.password=only-password"
        template: agent/deployment.yaml
