suite: Test Default Image Configuration
templates:
  - agent/deployment.yaml
  - agent/configmap.yaml
  - management/deployment.yaml
  - management/configmap.yaml
  - gateway/deployment.yaml
  - gateway/configmap.yaml
  - gateway/gateway-controlplane-configmap.yaml
  - piko/statefulset.yaml
  - piko/configmap.yaml
tests:
  - it: should use default image for agent deployment
    set:
      join_token: "test-token"
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^us-central1-docker\.pkg\.dev/prj-common-d-shared-89549/reg-d-common-docker-public/cra-agent:[0-9]+\.[0-9]+\.[0-9]+$
        template: agent/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Always"
        template: agent/deployment.yaml

  - it: should use default image for management deployment
    set:
      join_token: "test-token"
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^us-central1-docker\.pkg\.dev/prj-common-d-shared-89549/reg-d-common-docker-public/catalyst-management:[0-9]+\.[0-9]+\.[0-9]+$
        template: management/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Always"
        template: management/deployment.yaml

  - it: should use default image for gateway controlplane
    set:
      join_token: "test-token"
      gateway.controlplane.xds.mtls.enabled: false
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^us-central1-docker\.pkg\.dev/prj-common-d-shared-89549/reg-d-common-docker-public/catalyst-gateway:[0-9]+\.[0-9]+\.[0-9]+$
        template: gateway/deployment.yaml
        documentIndex: 1

  - it: should use default image for envoy proxy
    set:
      join_token: "test-token"
      gateway.controlplane.xds.mtls.enabled: false
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^us-central1-docker\.pkg\.dev/prj-common-d-shared-89549/reg-d-common-docker-hub-proxy/envoyproxy/envoy:distroless-v[0-9]+\.[0-9]+\.[0-9]+$
        template: gateway/deployment.yaml
        documentIndex: 0

  - it: should use default image for piko
    set:
      join_token: "test-token"
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^ghcr\.io/andydunstall/piko:v[0-9]+\.[0-9]+\.[0-9]+$
        template: piko/statefulset.yaml
